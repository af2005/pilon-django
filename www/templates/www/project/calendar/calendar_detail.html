{% extends "www/project/project_base.html" %}
{% load static %}

{% block additional_assets %}
    <link href='{% static "www/fullcalendar/custom.css" %}' rel='stylesheet'/>
    <link href='{% static "www/flatpickr/flatpickr.css" %}' rel='stylesheet'/>
{% endblock %}

{% block window_title %}
    {% with window_title=project.name|add:" - Calendar" %}
        {{ block.super }}
    {% endwith %}
{% endblock %}

{% block sidebar %}
    {% with active_sidebar_item="Calendar" %}
        {{ block.super }}
    {% endwith%}
{% endblock %}

{% block title %}
    {% with page_title="Calendar" %}
        {{ block.super }}
    {% endwith %}
{% endblock %}

{% block additional_scripts_eob %}
    <script src='{% static "www/flatpickr/flatpickr.js" %}'></script>
    <script src='{% static "www/fullcalendar/main.min.js" %}'></script>
    <script src='{% static "www/fullcalendar/custom.js" %}'></script>

    <script src='{% static "www/jquery/jquery-3.5.1.min.js" %}'></script>
    <script type="application/javascript">

        document.addEventListener('DOMContentLoaded', function () {


            function formatDate(d) {
                let date = [
                    d.getFullYear(),
                    ('0' + (d.getMonth() + 1)).slice(-2),
                    ('0' + d.getDate()).slice(-2)
                ].join('-');
                date += " " + ('0' + d.getHours()).slice(-2) + ":" + ('0' + d.getMinutes()).slice(-2);
                return date

            }

            function get_form_value(dom_name) {
                return $("#calendar-event-modal input[name=" + dom_name + "]").val();
            }

            function set_form_value(dom_name, value) {
                return $("#calendar-event-modal input[name=" + dom_name + "]").val(value);
            }

            function open_edit_event_modal(eventInfo) {
                $("#calendar-event-modal-heading").text("Edit event " + eventInfo.event.title);
                $("#calendar-event-modal button[name='delete-button']").removeClass("d-none");
                $("#calendar-event-modal button[name='delete-button']").unbind().click(function () {
                    send_delete_event(eventInfo);
                    calendar.refetchEvents();
                    $("#calendar-event-modal").modal('hide');
                });
                set_form_value("title", eventInfo.event.title);
                set_form_value("description", eventInfo.event.extendedProps.description);
                set_form_value("old_start", formatDate(eventInfo.event.start));
                set_form_value("old_end", formatDate(eventInfo.event.end));
                set_form_value("start", formatDate(eventInfo.event.start));
                set_form_value("end", formatDate(eventInfo.event.end));
                set_form_value("event_id", eventInfo.event.extendedProps.event_id);
                $("#calendar-event-modal button[name='submit']").html("Edit Event");

                $("#calendar-event-modal-form").unbind().on("submit", function (event) {
                    event.preventDefault();
                    const e = {};
                    e.event = {};
                    e.oldEvent = {};
                    e.event.extendedProps = {};
                    e.event.title = get_form_value("title");
                    e.event.startStr = get_form_value("start");
                    e.event.endStr = get_form_value("end");
                    e.oldEvent.startStr = get_form_value("old_start");
                    e.oldEvent.endStr = get_form_value("old_end");
                    e.event.extendedProps.description = get_form_value("description");
                    e.event.extendedProps.event_id = get_form_value("event_id");
                    e.event.extendedProps.existed = get_form_value("existed");
                    e.event.extendedProps.calendar = get_form_value("calendar_slug");
                    send_edited_event(e);
                    calendar.refetchEvents();
                });

                flatpickr("#calendar-event-modal input[name='start']", {
                    enableTime: true,
                    dateFormat: "Y-m-d H:i",
                    time_24hr: true,
                });

                flatpickr("#calendar-event-modal input[name='end']", {
                    enableTime: true,
                    dateFormat: "Y-m-d H:i",
                    time_24hr: true,
                });
                //$("#calendar-event-modal input[name='start']")._flatpickr.jumpToDate(eventInfo.event.start);
                $("#calendar-event-modal").modal('show');

            }

            function open_create_event_modal() {
                $("#calendar-event-modal-heading").text("Create new event");
                $("#calendar-event-modal button[name='delete-button']").addClass("d-none");
                $("#calendar-event-modal input[name='title']").val("");
                $("#calendar-event-modal input[name='description']").val("");
                $("#calendar-event-modal input[name='old_start']").val();
                $("#calendar-event-modal input[name='old_end']").val();
                $("#calendar-event-modal input[name='start']").val("");
                $("#calendar-event-modal input[name='end']").val("");
                $("#calendar-event-modal button[name='submit']").html("Create Event");
                $("#calendar-event-modal-form").unbind().on("submit", function (event) {
                    event.preventDefault();
                    const e = {};
                    e.title = get_form_value("title");
                    e.start = get_form_value("start");
                    e.end = get_form_value("end");
                    e.description = get_form_value("description");
                    send_new_event(e);
                    calendar.refetchEvents();
                });

                flatpickr("#calendar-event-modal input[name='start']", {
                    enableTime: true,
                    dateFormat: "Y-m-d H:i",
                    time_24hr: true,
                });

                flatpickr("#calendar-event-modal input[name='end']", {
                    enableTime: true,
                    dateFormat: "Y-m-d H:i",
                    time_24hr: true,
                });
                //$("#calendar-event-modal input[name='start']")._flatpickr.jumpToDate(eventInfo.event.start);
                $("#calendar-event-modal").modal('show');

            }

            function send_new_event(eventInfo) {
                $.ajax({
                    type: 'POST',
                    url: "{% url 'schedule_create_event' %}",
                    dataType: 'json',
                    data: {
                        "title": eventInfo.title,
                        "start": eventInfo.start,
                        "end": eventInfo.end,
                        "calendar_slug": "{{ project.key }}",
                        "description": eventInfo.description
                    },
                    success: function (result) {
                        calendar.refetchEvents();
                        $("#calendar-event-modal").modal('hide');
                    },
                    error: function (req, status, error) {
                        console.log(error);
                    }
                });
                return false;
            }

            function send_edited_event(eventInfo) {
                $.ajax({
                    type: 'POST',
                    url: "{% url 'schedule_edit_event' %}",
                    dataType: 'json',
                    data: {
                        "title": eventInfo.event.title,
                        "description": eventInfo.event.extendedProps.description,
                        "event_start": eventInfo.event.startStr,
                        "event_end": eventInfo.event.endStr,
                        "old_event_start": eventInfo.oldEvent.startStr,
                        "old_event_end": eventInfo.oldEvent.endStr,
                        "event_id": eventInfo.event.extendedProps.event_id,
                        "existed": eventInfo.event.extendedProps.existed,
                        "calendar": eventInfo.event.extendedProps.calendar,

                    },
                    success: function (result) {
                        calendar.refetchEvents();
                        $("#calendar-event-modal").modal('hide');
                    },
                    error: function (req, status, error) {
                        console.log(error);
                    }
                });
                return false;
            }

            function send_delete_event(eventInfo) {
                $.ajax({
                    type: 'POST',
                    url: "{% url 'schedule_delete_event' %}",
                    dataType: 'json',
                    data: {
                        "event_id": eventInfo.event.extendedProps.event_id,
                        "calendar": eventInfo.event.extendedProps.calendar,
                    },
                    success: function (result) {
                        calendar.refetchEvents();
                        $("#calendar-event-modal").modal('hide');
                    },
                    error: function (req, status, error) {
                        console.log(error);
                    }
                });
                return false;
            }


            const calendarEl = document.getElementById('full-calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                events: '{% url 'api_occurrences' %}?calendar_slug={{ project.key }}',
                timeZone: 'local',
                editable: true,
                initialView: 'dayGridMonth',
                firstDay: 1,
                themeSystem: 'bootstrap',
                eventTimeFormat: { // like '14:30:00'
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                },
                headerToolbar: {
                    start: 'prev,next today',
                    center: 'title',
                    end: 'dayGridMonth,dayGridWeek,timeGridDay createButton'
                },
                bootstrapFontAwesome: {
                    prev: ' bi bi-chevron-left',
                    next: ' bi bi-chevron-right',
                    prevYear: ' bi bi-chevron-double-left',
                    nextYear: ' bi bi-chevron-double-right',
                    close: 'bi bi-x'
                },
                customButtons: {
                    createButton: {
                        text: 'Add event...',
                        click: open_create_event_modal,
                    }
                },
                navLinks: true,
                navLinkDayClick: function (date) {
                    calendar.changeView('timeGridDay');
                    calendar.gotoDate(date);

                },
                eventResize: send_edited_event,
                eventDrop: send_edited_event,
                eventClick: open_edit_event_modal,
            });
            calendar.render();
        });

    </script>
{% endblock %}


{% block content %}
    <div id="full-calendar" class="mx-2 row shadow">
    </div>


    <div id="calendar-event-modal" class="modal fade" tabindex="-1" data-bs-backdrop="static"
         data-bs-keyboard="false" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="calendar-event-modal-form" method="post">
                    <div class="modal-header">
                        <h4 class="modal-title" id="calendar-event-modal-heading">Create new event</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">

                        {% csrf_token %}

                        <input type="hidden" name="calendar_slug" value="{{ project.key }}">
                        <input type="hidden" name="old_start" value="">
                        <input type="hidden" name="old_end" value="">
                        <input type="hidden" name="event_id" value="">
                        <input type="hidden" name="existed" value="">
                        <div class="input-group input-group-lg mb-1">
                            <input name="title" type="text" class="form-control" placeholder="Enter a title ..."
                                   aria-label="title"
                                   aria-describedby="basic-addon1">
                        </div>
                        <div class="input-group input-group-sm mb-3">
                            <input name="description" type="text" class="form-control"
                                   placeholder="Enter a description or location ..."
                                   aria-label="title"
                                   aria-describedby="basic-addon1">
                        </div>
                        <div class="input-group">
                            <span class="input-group-text" style="width: 6em;">Start time</span>
                            <input name="start" type="text" class="form-control datetime-selector"
                                   placeholder="Click to select a time"
                                   aria-label="Start time"
                                   aria-describedby="basic-addon1">
                        </div>
                        <div class="input-group mb-3">
                            <span class="input-group-text" style="width: 6em;">End time</span>
                            <input name="end" type="text" class="form-control datetime-selector"
                                   placeholder="Click to select a time"
                                   aria-label="End time"
                                   aria-describedby="basic-addon1">
                        </div>

                    </div>
                    <div class="modal-footer justify-content-between">
                        <div>
                            <button name="delete-button" type="button" class="btn btn-outline-danger d-none">Delete
                                Event
                            </button>
                        </div>
                        <div>
                            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" name="submit" class="btn btn-primary">Create Event</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>



{% endblock %}
